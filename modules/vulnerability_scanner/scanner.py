# -*- coding: utf-8 -*-
"""
Main vulnerability scanner orchestration
"""
import time
from typing import List, Optional
from .models import Dependency, PackageVulnerabilities, ScanResult, Vulnerability
from .parsers import DependencyParser
from .api_clients import OSVClient, NVDClient, GitHubAdvisoryClient


class VulnerabilityScanner:
    """
    Main vulnerability scanner that coordinates parsing, querying, and reporting
    """
    
    def __init__(self, use_nvd: bool = True, use_github: bool = True, nvd_api_key: Optional[str] = None, github_token: Optional[str] = None):
        """
        Initialize scanner with API clients
        
        Args:
            use_nvd: Enable NVD API queries (slower due to rate limits)
            use_github: Enable GitHub Advisory queries (requires token)
            nvd_api_key: Optional NVD API key for higher rate limits
            github_token: Optional GitHub token for advisory access
        """
        self.osv_client = OSVClient()
        self.nvd_client = NVDClient(nvd_api_key) if use_nvd else None
        self.github_client = GitHubAdvisoryClient(github_token) if use_github else None
        
        self.use_nvd = use_nvd
        self.use_github = use_github
    
    def scan_project(self, project_path: str) -> ScanResult:
        """
        Perform complete vulnerability scan on a project
        
        Args:
            project_path: Path to project directory
        
        Returns:
            ScanResult object with all findings
        """
        print("\n" + "="*80)
        print("ğŸ” VULNERABILITY SCANNER - DEEP DEPENDENCY ANALYSIS")
        print("="*80)
        
        start_time = time.time()
        result = ScanResult(project_path=project_path)
        
        try:
            # Step 1: Discover and parse dependencies
            dependencies = DependencyParser.discover_dependencies(project_path)
            result.total_dependencies = len(dependencies)
            
            if not dependencies:
                print("\nâš ï¸  No dependency files found or no dependencies extracted.")
                print("    Supported files: requirements.txt, package.json, pom.xml, build.gradle\n")
                return result
            
            # Step 2: Scan each dependency for vulnerabilities
            print(f"\n[*] Scanning {len(dependencies)} dependencies for vulnerabilities...\n")
            
            for idx, dep in enumerate(dependencies, 1):
                print(f"[{idx}/{len(dependencies)}] {dep.package} ({dep.version}) [{dep.ecosystem}]")
                
                try:
                    pkg_vulns = self._scan_dependency(dep)
                    result.packages.append(pkg_vulns)
                    result.total_vulnerabilities += pkg_vulns.get_total_count()
                    
                    if pkg_vulns.vulnerabilities:
                        severity_counts = pkg_vulns.get_severity_counts()
                        print(f"   âŒ Found {pkg_vulns.get_total_count()} vulnerabilities: ", end='')
                        parts = []
                        if severity_counts['CRITICAL']:
                            parts.append(f"CRITICAL:{severity_counts['CRITICAL']}")
                        if severity_counts['HIGH']:
                            parts.append(f"HIGH:{severity_counts['HIGH']}")
                        if severity_counts['MEDIUM']:
                            parts.append(f"MEDIUM:{severity_counts['MEDIUM']}")
                        if severity_counts['LOW']:
                            parts.append(f"LOW:{severity_counts['LOW']}")
                        print(", ".join(parts))
                    else:
                        print("   âœ… No known vulnerabilities")
                
                except Exception as e:
                    error_msg = f"Error scanning {dep.package}: {e}"
                    print(f"   âš ï¸  {error_msg}")
                    result.errors.append(error_msg)
                
                print()  # Blank line between packages
            
            # Calculate scan duration
            result.scan_duration = time.time() - start_time
            
            # Print summary
            self._print_summary(result)
        
        except Exception as e:
            error_msg = f"Scan failed: {e}"
            print(f"\nâŒ {error_msg}")
            result.errors.append(error_msg)
        
        return result
    
    def _scan_dependency(self, dependency: Dependency) -> PackageVulnerabilities:
        """
        Scan a single dependency across all vulnerability sources
        
        Args:
            dependency: Dependency object to scan
        
        Returns:
            PackageVulnerabilities with all found issues
        """
        pkg_vulns = PackageVulnerabilities(dependency=dependency)
        all_vulnerabilities = []
        
        # Query OSV (always enabled, free and fast)
        try:
            print("      â†’ Querying OSV...", end=' ', flush=True)
            osv_vulns = self.osv_client.query_package(
                dependency.package,
                dependency.version,
                dependency.ecosystem
            )
            if osv_vulns:
                print(f"âœ“ {len(osv_vulns)} found")
                all_vulnerabilities.extend(osv_vulns)
            else:
                print("âœ“ clean")
        except Exception as e:
            print(f"âœ— error: {e}")
        
        # Query NVD (optional, slower)
        if self.use_nvd and self.nvd_client:
            try:
                print("      â†’ Querying NVD...", end=' ', flush=True)
                nvd_vulns = self.nvd_client.query_package(dependency.package)
                if nvd_vulns:
                    print(f"âœ“ {len(nvd_vulns)} found")
                    all_vulnerabilities.extend(nvd_vulns)
                else:
                    print("âœ“ clean")
            except Exception as e:
                print(f"âœ— error: {e}")
        
        # Query GitHub (optional, requires token)
        if self.use_github and self.github_client:
            try:
                print("      â†’ Querying GitHub...", end=' ', flush=True)
                gh_vulns = self.github_client.query_package(
                    dependency.package,
                    dependency.ecosystem
                )
                if gh_vulns:
                    print(f"âœ“ {len(gh_vulns)} found")
                    all_vulnerabilities.extend(gh_vulns)
                else:
                    print("âœ“ clean")
            except Exception as e:
                print(f"âœ— error: {e}")
        
        # Deduplicate vulnerabilities by ID
        seen_ids = set()
        for vuln in all_vulnerabilities:
            if vuln.id not in seen_ids:
                seen_ids.add(vuln.id)
                pkg_vulns.vulnerabilities.append(vuln)
        
        return pkg_vulns
    
    def _print_summary(self, result: ScanResult):
        """Print scan summary"""
        summary = result.get_summary()
        
        print("\n" + "="*80)
        print("ğŸ“Š VULNERABILITY SCAN SUMMARY")
        print("="*80)
        print(f"\nğŸ“¦ Total Dependencies Scanned: {summary['total_dependencies']}")
        print(f"âš ï¸  Vulnerable Packages: {summary['vulnerable_packages']}")
        print(f"ğŸ”´ Total Vulnerabilities: {summary['total_vulnerabilities']}")
        
        if summary['total_vulnerabilities'] > 0:
            print(f"\n   Severity Breakdown:")
            if summary['critical']:
                print(f"   ğŸ”´ CRITICAL: {summary['critical']}")
            if summary['high']:
                print(f"   ğŸŸ  HIGH:     {summary['high']}")
            if summary['medium']:
                print(f"   ğŸŸ¡ MEDIUM:   {summary['medium']}")
            if summary['low']:
                print(f"   ğŸŸ¢ LOW:      {summary['low']}")
            if summary['info']:
                print(f"   â„¹ï¸  INFO:     {summary['info']}")
        
        print(f"\nâ±ï¸  Scan Duration: {summary['scan_duration']}")
        print("="*80 + "\n")
        
        # Risk assessment
        if summary['critical'] > 0:
            print("âš ï¸  CRITICAL RISK: Immediate action required!")
        elif summary['high'] > 0:
            print("âš ï¸  HIGH RISK: Update vulnerable packages as soon as possible")
        elif summary['medium'] > 0:
            print("âš ï¸  MEDIUM RISK: Review and plan updates")
        elif summary['total_vulnerabilities'] > 0:
            print("â„¹ï¸  LOW RISK: Monitor and update when convenient")
        else:
            print("âœ… All dependencies are clean! No known vulnerabilities found.")
        
        print()







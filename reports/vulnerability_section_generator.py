"""
Shared Vulnerability Section Generator
Used by both project_documentation_generator.py and pdf_report_generator.py
to ensure identical vulnerability sections in all PDFs
"""

from reportlab.lib import colors
from reportlab.lib.units import inch
from reportlab.platypus import Paragraph, Spacer, Table, TableStyle, PageBreak


def generate_vulnerability_section(story, vulnerability_data, styles):
    """
    Generate comprehensive Vulnerability Management section with CVE mapping
    
    This is the master function used by ALL PDF generators to ensure consistency.
    
    Args:
        story: ReportLab story list to append elements to
        vulnerability_data: Dictionary containing vulnerability scan results
        styles: ReportLab styles dictionary
    
    Returns:
        None (modifies story in place)
    """
    
    # Section Header
    story.append(PageBreak())
    story.append(Paragraph("VULNERABILITY MANAGEMENT REPORT", styles['SectionHeader']))
    story.append(Spacer(1, 0.2*inch))
    
    # Check if vulnerability data exists
    if not vulnerability_data or 'packages' not in vulnerability_data:
        story.append(Paragraph(
            "No vulnerability scan data available. Run the vulnerability scanner to generate this report.",
            styles['Normal']
        ))
        story.append(Spacer(1, 0.2*inch))
        
        # Show example data structure
        heading_style = styles.get('Heading3', styles['Normal'])
        story.append(Paragraph("<b>Expected Data Structure:</b>", heading_style))
        story.append(Spacer(1, 0.1*inch))
        
        example_text = """
        To populate this section, run: <b>python scan_vulnerabilities.py [project_path] --output json</b><br/><br/>
        The scanner will detect dependencies from:<br/>
        • requirements.txt (Python/PyPI)<br/>
        • package.json (JavaScript/npm)<br/>
        • pom.xml (Java/Maven)<br/>
        • build.gradle (Java/Gradle)<br/><br/>
        And query multiple vulnerability databases:<br/>
        • OSV (Open Source Vulnerabilities)<br/>
        • NVD (National Vulnerability Database)<br/>
        • GitHub Security Advisories
        """
        story.append(Paragraph(example_text, styles['Normal']))
        story.append(Spacer(1, 0.3*inch))
        return
    
    # Extract summary and packages
    summary = vulnerability_data.get('summary', {})
    packages = vulnerability_data.get('packages', [])
    
    # Check if no dependencies or vulnerabilities
    total_deps = summary.get('total_dependencies', 0)
    total_vulns = summary.get('total_vulnerabilities', 0)
    
    if total_deps == 0:
        story.append(Paragraph(
            "No dependency files found in project.",
            styles['Normal']
        ))
        story.append(Spacer(1, 0.3*inch))
        return
    
    if total_vulns == 0:
        story.append(Paragraph(
            f"All {total_deps} dependencies are clean! No known vulnerabilities found.",
            styles['Normal']
        ))
        story.append(Spacer(1, 0.3*inch))
        return
    
    # ========================================
    # SUMMARY STATISTICS TABLE
    # ========================================
    summary_data = [
        ['Metric', 'Count', 'Details'],
        ['Total Dependencies', str(total_deps), 'All packages analyzed'],
        ['Vulnerable Packages', str(summary.get('vulnerable_packages', 0)), 'Packages with known CVEs'],
        ['Total Vulnerabilities', str(total_vulns), 'Unique vulnerability IDs'],
        ['CRITICAL Severity', str(summary.get('critical', 0)), 'CVSS 9.0-10.0'],
        ['HIGH Severity', str(summary.get('high', 0)), 'CVSS 7.0-8.9'],
        ['MEDIUM Severity', str(summary.get('medium', 0)), 'CVSS 4.0-6.9'],
        ['LOW Severity', str(summary.get('low', 0)), 'CVSS 0.1-3.9'],
    ]
    
    summary_table = Table(summary_data, colWidths=[2*inch, 1.2*inch, 2.8*inch])
    summary_table.setStyle(TableStyle([
        ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor('#2c3e50')),
        ('TEXTCOLOR', (0, 0), (-1, 0), colors.white),
        ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
        ('FONTSIZE', (0, 0), (-1, -1), 9),
        ('ALIGN', (0, 0), (-1, -1), 'LEFT'),
        ('GRID', (0, 0), (-1, -1), 1, colors.black),
        ('ROWBACKGROUNDS', (0, 1), (-1, -1), [colors.whitesmoke, colors.lightgrey]),
        ('BACKGROUND', (0, 4), (-1, 4), colors.HexColor('#ffebee')),  # Critical row
        ('BACKGROUND', (0, 5), (-1, 5), colors.HexColor('#fff3e0')),  # High row
    ]))
    
    story.append(summary_table)
    story.append(Spacer(1, 0.3*inch))
    
    # Check if packages exist
    if not packages:
        story.append(Paragraph("No vulnerabilities detected in scanned dependencies!", styles['Normal']))
        return
    
    # ========================================
    # VULNERABLE PACKAGES OVERVIEW TABLE (with CVE mapping)
    # ========================================
    heading_style = styles.get('Heading3', styles['Normal'])
    story.append(Paragraph("VULNERABLE PACKAGES OVERVIEW", heading_style))
    story.append(Spacer(1, 0.15*inch))
    
    # Sort packages by severity (highest first)
    severity_order = {'CRITICAL': 0, 'HIGH': 1, 'MEDIUM': 2, 'LOW': 3, 'INFO': 4}
    packages_sorted = sorted(
        packages,
        key=lambda p: severity_order.get(p.get('highest_severity', 'INFO'), 5)
    )
    
    # Create package overview table with CVE references
    pkg_overview_data = [['Package', 'Version', 'Ecosystem', 'Vulns', 'Severity', 'CVE References']]
    
    for pkg in packages_sorted[:20]:  # Show top 20 packages
        package_name = pkg.get('package', 'Unknown')
        version = pkg.get('version', 'Unknown')
        ecosystem = pkg.get('ecosystem', 'Unknown')
        vuln_count = pkg.get('vulnerability_count', 0)
        highest_severity = pkg.get('highest_severity', 'UNKNOWN')
        
        # Extract CVE IDs from vulnerabilities
        vulnerabilities = pkg.get('vulnerabilities', [])
        cve_list = []
        
        for vuln in vulnerabilities:
            vuln_id = vuln.get('id', '')
            
            # Check if ID is CVE
            if vuln_id.startswith('CVE-'):
                cve_list.append(vuln_id)
            else:
                # Check aliases field for CVE IDs (from OSV data structure)
                aliases = vuln.get('aliases', [])
                for alias in aliases:
                    if alias.startswith('CVE-'):
                        cve_list.append(alias)
            
            # IMPORTANT: Also check references for CVE URLs
            # OSV often includes CVE as: https://nvd.nist.gov/vuln/detail/CVE-XXXX-XXXXX
            references = vuln.get('references', [])
            for ref in references:
                if 'CVE-' in ref:
                    # Extract CVE number from URL or text
                    import re
                    cve_match = re.search(r'CVE-\d{4}-\d+', ref)
                    if cve_match:
                        cve_num = cve_match.group(0)
                        if cve_num not in cve_list:
                            cve_list.append(cve_num)
        
        # Format CVE references for display
        if cve_list:
            # Limit to first 3 CVEs to avoid overflow
            cve_display = ', '.join(cve_list[:3])
            if len(cve_list) > 3:
                cve_display += f' (+{len(cve_list)-3} more)'
        else:
            cve_display = 'N/A'
        
        pkg_overview_data.append([
            package_name,
            version,
            ecosystem,
            str(vuln_count),
            highest_severity,
            cve_display
        ])
    
    pkg_overview_table = Table(pkg_overview_data, colWidths=[1.2*inch, 0.8*inch, 0.7*inch, 0.5*inch, 0.7*inch, 2.1*inch])
    
    # Build table style with color coding
    table_style_list = [
        ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor('#2c3e50')),
        ('TEXTCOLOR', (0, 0), (-1, 0), colors.white),
        ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
        ('FONTSIZE', (0, 0), (-1, -1), 7),
        ('ALIGN', (0, 0), (-1, -1), 'LEFT'),
        ('VALIGN', (0, 0), (-1, -1), 'TOP'),
        ('GRID', (0, 0), (-1, -1), 0.5, colors.black),
        ('ROWBACKGROUNDS', (0, 1), (-1, -1), [colors.white, colors.HexColor('#f8f9fa')]),
        ('LEFTPADDING', (0, 0), (-1, -1), 4),
        ('RIGHTPADDING', (0, 0), (-1, -1), 4),
        ('TOPPADDING', (0, 0), (-1, -1), 4),
        ('BOTTOMPADDING', (0, 0), (-1, -1), 4),
    ]
    
    # Color-code severity column
    for i in range(1, len(pkg_overview_data)):
        severity = pkg_overview_data[i][4]
        if severity == 'CRITICAL':
            table_style_list.append(('BACKGROUND', (4, i), (4, i), colors.HexColor('#8B0000')))
            table_style_list.append(('TEXTCOLOR', (4, i), (4, i), colors.white))
        elif severity == 'HIGH':
            table_style_list.append(('BACKGROUND', (4, i), (4, i), colors.HexColor('#c0392b')))
            table_style_list.append(('TEXTCOLOR', (4, i), (4, i), colors.white))
        elif severity == 'MEDIUM':
            table_style_list.append(('BACKGROUND', (4, i), (4, i), colors.HexColor('#e67e22')))
            table_style_list.append(('TEXTCOLOR', (4, i), (4, i), colors.white))
        elif severity == 'LOW':
            table_style_list.append(('BACKGROUND', (4, i), (4, i), colors.HexColor('#f39c12')))
    
    pkg_overview_table.setStyle(TableStyle(table_style_list))
    story.append(pkg_overview_table)
    story.append(Spacer(1, 0.3*inch))
    
    # ========================================
    # DETAILED VULNERABILITY BREAKDOWN
    # ========================================
    story.append(Paragraph("DETAILED VULNERABILITY BREAKDOWN", heading_style))
    story.append(Spacer(1, 0.15*inch))
    
    for pkg in packages_sorted[:15]:  # Limit to top 15 most critical
        package_name = pkg.get('package', 'Unknown')
        version = pkg.get('version', 'Unknown')
        ecosystem = pkg.get('ecosystem', 'Unknown')
        vuln_count = pkg.get('vulnerability_count', 0)
        highest_severity = pkg.get('highest_severity', 'UNKNOWN')
        
        # Package header
        pkg_header = f"<b>{package_name}</b> v{version} [{ecosystem}] - {vuln_count} vulnerabilities"
        
        severity_color = {
            'CRITICAL': colors.HexColor('#8B0000'),
            'HIGH': colors.HexColor('#c0392b'),
            'MEDIUM': colors.HexColor('#e67e22'),
            'LOW': colors.HexColor('#f39c12')
        }.get(highest_severity, colors.grey)
        
        pkg_data = [[Paragraph(pkg_header, styles['Normal'])]]
        pkg_table = Table(pkg_data, colWidths=[6*inch])
        pkg_table.setStyle(TableStyle([
            ('BACKGROUND', (0, 0), (-1, -1), severity_color),
            ('TEXTCOLOR', (0, 0), (-1, -1), colors.white),
            ('FONTNAME', (0, 0), (-1, -1), 'Helvetica-Bold'),
            ('FONTSIZE', (0, 0), (-1, -1), 10),
            ('ALIGN', (0, 0), (-1, -1), 'LEFT'),
            ('LEFTPADDING', (0, 0), (-1, -1), 8),
            ('RIGHTPADDING', (0, 0), (-1, -1), 8),
            ('TOPPADDING', (0, 0), (-1, -1), 6),
            ('BOTTOMPADDING', (0, 0), (-1, -1), 6),
        ]))
        
        story.append(pkg_table)
        story.append(Spacer(1, 0.05*inch))
        
        # Vulnerability details
        vulnerabilities = pkg.get('vulnerabilities', [])
        
        for vuln in vulnerabilities[:5]:  # Limit to 5 vulns per package
            vuln_id = vuln.get('id', 'N/A')
            summary_text = vuln.get('summary', 'No summary available')
            severity = vuln.get('severity', 'UNKNOWN')
            cvss_score = vuln.get('cvss_score', 'N/A')
            exploit_available = vuln.get('exploit_available', False)
            fixed_version = vuln.get('fixed_version', 'Not specified')
            published = vuln.get('published_date', 'Unknown')
            references = vuln.get('references', [])
            
            # Extract CVE aliases for display
            aliases = vuln.get('aliases', [])
            cve_aliases = [alias for alias in aliases if alias.startswith('CVE-')]
            
            # IMPORTANT: Also extract CVE from references (OSV format)
            if not cve_aliases and references:
                import re
                for ref in references:
                    if 'CVE-' in ref:
                        cve_match = re.search(r'CVE-\d{4}-\d+', ref)
                        if cve_match:
                            cve_aliases.append(cve_match.group(0))
                            break  # Just get the first one for display
            
            # If primary ID is not CVE but we have CVE aliases, show them
            cve_display = vuln_id
            if not vuln_id.startswith('CVE-') and cve_aliases:
                cve_display = f"{vuln_id} ({', '.join(cve_aliases)})"
            
            # Vulnerability detail table
            # Format CVSS score properly
            cvss_display = f"{cvss_score:.1f}" if cvss_score and cvss_score != 'N/A' else 'Not Available'
            
            vuln_detail_data = [
                ['ID:', cve_display, 'Severity:', f"{severity} (CVSS: {cvss_display})"],
                ['Summary:', Paragraph(summary_text[:150] + "..." if len(summary_text) > 150 else summary_text, 
                                     styles['Normal']), '', ''],
                ['Published:', published[:10] if published else 'N/A', 
                 'Exploit:', 'YES' if exploit_available else 'No'],
                ['Fixed Version:', fixed_version, '', ''],
            ]
            
            if references:
                ref_text = '<br/>'.join([f"• {ref[:80]}" for ref in references[:3]])
                vuln_detail_data.append(['References:', Paragraph(ref_text, styles['Normal']), '', ''])
            
            vuln_table = Table(vuln_detail_data, colWidths=[1*inch, 2.3*inch, 0.8*inch, 1.9*inch])
            vuln_table.setStyle(TableStyle([
                ('BACKGROUND', (0, 0), (-1, -1), colors.HexColor('#f8f9fa')),
                ('FONTSIZE', (0, 0), (-1, -1), 7),
                ('ALIGN', (0, 0), (-1, -1), 'LEFT'),
                ('VALIGN', (0, 0), (-1, -1), 'TOP'),
                ('GRID', (0, 0), (-1, -1), 0.5, colors.grey),
                ('FONTNAME', (0, 0), (0, -1), 'Helvetica-Bold'),
                ('LEFTPADDING', (0, 0), (-1, -1), 5),
                ('RIGHTPADDING', (0, 0), (-1, -1), 5),
                ('TOPPADDING', (0, 0), (-1, -1), 3),
                ('BOTTOMPADDING', (0, 0), (-1, -1), 3),
            ]))
            
            story.append(vuln_table)
            story.append(Spacer(1, 0.08*inch))
        
        if len(vulnerabilities) > 5:
            story.append(Paragraph(
                f"<i>... and {len(vulnerabilities) - 5} more vulnerabilities</i>",
                styles['Normal']
            ))
        
        story.append(Spacer(1, 0.15*inch))
    
    if len(packages) > 15:
        story.append(Paragraph(
            f"<b>Note:</b> Showing top 15 most critical packages. "
            f"{len(packages) - 15} additional vulnerable packages were detected.",
            styles['Normal']
        ))
    
    story.append(Spacer(1, 0.2*inch))

